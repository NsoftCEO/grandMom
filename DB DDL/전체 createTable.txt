CREATE TABLE `user` (
  `user_id` varchar(100) NOT NULL,
  `name` varchar(100) NOT NULL,
  `password` varchar(255) NOT NULL,
  `email` varchar(255) NOT NULL,
  `phone` varchar(30) DEFAULT NULL,
  `created_at` datetime DEFAULT current_timestamp(),
  `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`user_id`),
  UNIQUE KEY `email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE `address` (
  `address_id` bigint(20) NOT NULL AUTO_INCREMENT,
  `user_id` varchar(100) NOT NULL,
  `recipient` varchar(100) NOT NULL,
  `phone` varchar(30) DEFAULT NULL,
  `zipcode` varchar(20) DEFAULT NULL,
  `addr_line1` varchar(255) NOT NULL,
  `addr_line2` varchar(255) DEFAULT NULL,
  `is_default` tinyint(1) DEFAULT 0,
  `created_at` datetime DEFAULT current_timestamp(),
  `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`address_id`),
  KEY `user_id` (`user_id`),
  CONSTRAINT `address_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`user_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE product_category (
    category_id     BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    category_name   VARCHAR(100) NOT NULL COMMENT '카테고리명',

    use_yn          CHAR(1) NOT NULL DEFAULT 'Y'
                    COMMENT '사용 여부 (Y/N)',

    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                    ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT uk_category_name
        UNIQUE (category_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE product (
    product_id     BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    product_name   VARCHAR(255) NOT NULL COMMENT '상품명',
    price       INT NOT NULL COMMENT '정가',
    sale_price  INT NULL COMMENT '할인 판매가',
    description    TEXT COMMENT '상품 상세 설명',

    category_id    BIGINT UNSIGNED COMMENT '카테고리 ID',

    status ENUM('ACTIVE','HIDDEN','STOP')
           NOT NULL DEFAULT 'ACTIVE'
           COMMENT '상품 판매 상태',

    created_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                   ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT fk_product_category
        FOREIGN KEY (category_id)
        REFERENCES product_category(category_id)
) ENGINE=InnoDB
DEFAULT CHARSET=utf8mb4
COMMENT='상품 정보';

CREATE TABLE product_option (
    option_id        BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    product_id       BIGINT UNSIGNED NOT NULL,

    color            VARCHAR(50) NOT NULL DEFAULT 'DEFAULT'
                     COMMENT '색상',
    size             VARCHAR(50) NOT NULL DEFAULT 'FREE'
                     COMMENT '사이즈',
    stock_quantity   INT NOT NULL
                     COMMENT '재고 수량',

    created_at       TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at       TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                     ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT fk_option_product
        FOREIGN KEY (product_id)
        REFERENCES product(product_id),

    CONSTRAINT uk_product_option
        UNIQUE (product_id, color, size),

    CONSTRAINT chk_stock_quantity
        CHECK (stock_quantity >= 0)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


CREATE TABLE product_image (
    image_id        BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    product_id      BIGINT UNSIGNED NOT NULL,
    option_id       BIGINT UNSIGNED DEFAULT NULL,

    image_url       VARCHAR(512) NOT NULL,
    original_name   VARCHAR(255),

    image_type      VARCHAR(20) NOT NULL DEFAULT 'DETAIL'
                    COMMENT 'MAIN, DETAIL, OPTION, DESC',

    sort_order      INT DEFAULT 0,
    use_yn          CHAR(1) NOT NULL DEFAULT 'Y'
                    COMMENT '사용 여부 (Y/N)',

    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_image_product
        FOREIGN KEY (product_id)
        REFERENCES product(product_id)
        ON DELETE RESTRICT,

    CONSTRAINT fk_image_option
        FOREIGN KEY (option_id)
        REFERENCES product_option(option_id)
        ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;



CREATE TABLE orders (
    order_id         BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id          VARCHAR(100) NOT NULL,

    order_name       VARCHAR(255) NOT NULL,
    total_amount     INT NOT NULL,

    order_status     VARCHAR(30) NOT NULL
                     COMMENT 'PAYMENT_READY, PAID, COMPLETED, CANCELLED, FAILED',

    receiver_name    VARCHAR(100) NOT NULL,
    receiver_phone   VARCHAR(30) NOT NULL,
    receiver_address VARCHAR(255) NOT NULL,
    delivery_memo    VARCHAR(255),

    created_at       TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at       TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                     ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


CREATE TABLE order_item (
    order_item_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    order_id      BIGINT UNSIGNED NOT NULL,
    product_id    BIGINT UNSIGNED NOT NULL,
    option_id     BIGINT UNSIGNED NULL,

    product_name  VARCHAR(255) NOT NULL,
    unit_price    INT NOT NULL,
    quantity      INT NOT NULL,
    total_price   INT NOT NULL,

    color         VARCHAR(50) NOT NULL,
    size          VARCHAR(50) NOT NULL,

    option_info   JSON,
    refund_status VARCHAR(20) NOT NULL DEFAULT 'NONE',

    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_order_item_order
        FOREIGN KEY (order_id)
        REFERENCES orders(order_id)
        ON DELETE RESTRICT,

    CONSTRAINT fk_order_item_product
        FOREIGN KEY (product_id)
        REFERENCES product(product_id)
        ON DELETE RESTRICT,

    CONSTRAINT fk_order_item_option
        FOREIGN KEY (option_id)
        REFERENCES product_option(option_id)
        ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;



CREATE TABLE `cart` (
  `cart_id` bigint(20) NOT NULL AUTO_INCREMENT,
  `user_id` varchar(100) NOT NULL,
  `product_id` bigint(20) UNSIGNED NOT NULL,
  `quantity` int(11) NOT NULL,
  `created_at` datetime DEFAULT current_timestamp(),
  `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`cart_id`),
  KEY `product_id` (`product_id`),
  KEY `fk_cart_user` (`user_id`),
  CONSTRAINT `cart_ibfk_2` FOREIGN KEY (`product_id`) REFERENCES `product` (`product_id`),
  CONSTRAINT `fk_cart_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`user_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;


CREATE TABLE payment (
    payment_id           VARCHAR(50)  NOT NULL,
    order_id             BIGINT       NOT NULL,
    payment_provider     VARCHAR(30)  NOT NULL,
    payment_method_type  VARCHAR(30)  NOT NULL,
    payment_status       VARCHAR(20)  NOT NULL,
    pg_tx_id             VARCHAR(50)  NOT NULL,
    paid_at              DATETIME     NOT NULL,
    amount               INT          NOT NULL,
    cancel_amount        INT          NOT NULL DEFAULT 0,
    created_at           TIMESTAMP    DEFAULT CURRENT_TIMESTAMP,
    updated_at           TIMESTAMP    DEFAULT CURRENT_TIMESTAMP
                             ON UPDATE CURRENT_TIMESTAMP,
    CONSTRAINT pk_payment PRIMARY KEY (payment_id),
    CONSTRAINT uk_payment_pg_tx_id UNIQUE (pg_tx_id)
) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci;
  
  