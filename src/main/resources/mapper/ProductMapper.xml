<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="ko.dh.goot.dao.ProductMapper">

<resultMap id="ProductListResultMap" type="ko.dh.goot.dto.ProductList">
    <id property="productId" column="product_id"/>
    <result property="productName" column="product_name"/>
    <result property="price" column="price"/>
    <result property="salePrice" column="sale_price"/>
    <result property="status" column="status"/>
    <result property="createdAt" column="created_at"/>
    <result property="totalStock" column="total_stock"/>
    <result property="mainImageUrl" column="main_image_url"/>
</resultMap>

<resultMap id="ProductWithImagesResultMap" type="ko.dh.goot.dto.Product">
    <id property="productId" column="product_id"/>
    <result property="productName" column="product_name"/>
    <result property="price" column="price"/>
    <result property="category" column="category"/>
    <result property="stock" column="stock"/>
    <result property="description" column="description"/>
    <result property="createdAt" column="created_at"/>
    <result property="updatedAt" column="updated_at"/>

    <collection property="images" ofType="ko.dh.goot.dto.ProductImage">
        <id property="imageId" column="image_id"/>
        <result property="productId" column="product_id"/>
        <result property="imagePath" column="image_path"/>
        <result property="sortOrder" column="sort_order"/>
        <result property="createdAt" column="image_created_at"/>
        <result property="updatedAt" column="image_updated_at"/>
    </collection>
</resultMap>
	
<select id="selectProductList" parameterType="map" resultMap="ProductListResultMap">

    SELECT
        p.product_id,
        p.product_name,
        p.price,
        p.sale_price,
        p.status,
        p.created_at,
        IFNULL(opt.total_stock, 0) AS total_stock, /* 총 재고, 값이 null이면 0 반환 */
        img.image_url AS main_image_url /* 대표 이미지 */

    FROM product p

    /* 옵션 재고 집계 */
    LEFT JOIN (
        SELECT
            product_id,
            SUM(stock_quantity) AS total_stock
        FROM product_option
        GROUP BY product_id
    ) opt
        ON opt.product_id = p.product_id

    /* 대표 이미지 */
    LEFT JOIN product_image img
        ON img.product_id = p.product_id
       AND img.image_type = 'MAIN'
       AND img.use_yn = 'Y'
       AND img.sort_order = 0

    WHERE p.status = 'ACTIVE'

    <if test="categoryId != null">
        AND p.category_id = #{categoryId}
    </if>

    <if test="keyword != null and keyword != ''">
        AND p.product_name LIKE CONCAT('%', #{keyword}, '%')
    </if>

    ORDER BY p.created_at DESC

</select>



	<select id="selectProductById" parameterType="long" resultMap="ProductWithImagesResultMap">
    SELECT 
        p.product_id,
        p.product_name,
        p.price,
        p.category,
        p.stock,
        p.description,
        p.created_at,
        p.updated_at,
        pi.image_id,
        pi.image_path,
        pi.sort_order,
        pi.created_at AS image_created_at,
        pi.updated_at AS image_updated_at
    FROM product p
    LEFT JOIN product_image pi 
        ON p.product_id = pi.product_id
    WHERE p.product_id = #{productId}
    ORDER BY pi.sort_order ASC
	</select>
</mapper>