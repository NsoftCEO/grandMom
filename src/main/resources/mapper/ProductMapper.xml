<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="ko.dh.goot.dao.ProductMapper">

<resultMap id="ProductListResultMap" type="ko.dh.goot.dto.ProductListItem">
    <id property="productId" column="product_id"/>
    <result property="productName" column="product_name"/>
    <result property="price" column="price"/>
    <result property="salePrice" column="sale_price"/>
    <result property="status" column="status"/>
    <result property="createdAt" column="created_at"/>
    <result property="totalStock" column="total_stock"/>
    <result property="mainImageUrl" column="main_image_url"/>
</resultMap>

<resultMap id="ProductDetailResultMap" type="ko.dh.goot.dto.ProductDetail">
    <id property="productId" column="product_id"/>
    <result property="productName" column="product_name"/>
    <result property="price" column="price"/>
    <result property="salePrice" column="sale_price"/>
    <result property="description" column="description"/>
    <result property="status" column="status"/>
    <result property="createdAt" column="created_at"/>

    <association property="category" javaType="ko.dh.goot.dto.ProductCategory">
        <id property="categoryId" column="category_id"/>
        <result property="categoryName" column="category_name"/>
    </association>
</resultMap>

<resultMap id="ProductOptionResultMap" type="ko.dh.goot.dto.ProductOption">
    <id property="optionId" column="option_id"/>
    <result property="productId" column="product_id"/>
    <result property="color" column="color"/>
    <result property="size" column="size"/>
    <result property="stockQuantity" column="stock_quantity"/>
</resultMap>

<resultMap id="ProductImageResultMap" type="ko.dh.goot.dto.ProductImage">
    <id property="imageId" column="image_id"/>
    <result property="productId" column="product_id"/>
    <result property="fileName" column="file_name"/>
    <result property="imageType" column="image_type"/>
    <result property="sortOrder" column="sort_order"/>
</resultMap>




	
<select id="selectProductList" parameterType="map" resultMap="ProductListResultMap">

    SELECT
        p.product_id,
        p.product_name,
        p.price,
        p.sale_price,
        p.status,
        p.created_at,
        IFNULL(opt.total_stock, 0) AS total_stock, /* 총 재고, 값이 null이면 0 반환 */
        img.file_name AS main_image_url /* 대표 이미지 */

    FROM product p

    /* 옵션 재고 집계 */
    LEFT JOIN (
        SELECT
            product_id,
            SUM(stock_quantity) AS total_stock
        FROM product_option
        GROUP BY product_id
    ) opt
        ON opt.product_id = p.product_id

    /* 대표 이미지 */
    LEFT JOIN product_image img
        ON img.product_id = p.product_id
       AND img.image_type = 'MAIN'
       AND img.use_yn = 'Y'
       AND img.sort_order = 0

    WHERE p.status = 'ACTIVE'

    <if test="categoryId != null">
        AND p.category_id = #{categoryId}
    </if>

    <if test="keyword != null and keyword != ''">
        AND p.product_name LIKE CONCAT('%', #{keyword}, '%')
    </if>

    ORDER BY p.created_at DESC

</select>

<select id="selectProductDetail" parameterType="long" resultMap="ProductDetailResultMap">

	SELECT
	    p.product_id,
	    p.product_name,
	    p.price,
	    p.sale_price,
	    p.description,
	    p.status,
	
	    c.category_id,
	    c.category_name
	FROM product p
	LEFT JOIN product_category c
	  ON p.category_id = c.category_id
	 AND c.use_yn = 'Y'
	WHERE p.product_id = #{productId}
	  AND p.status = 'ACTIVE';
	  
</select>

<select id="selectProductOptions" parameterType="long" resultMap="ProductOptionResultMap">

	SELECT
	    option_id,
	    product_id,
	    color,
	    size,
	    stock_quantity
	FROM product_option
	WHERE product_id = #{productId}
	ORDER BY color, size;
  
</select>

<select id="selectProductImages" parameterType="long" resultMap="ProductImageResultMap">

	SELECT
	    image_id,
	    product_id,
	    file_name,
	    image_type,
	    sort_order
	FROM product_image
	WHERE product_id = #{productId}
	  AND use_yn = 'Y'
	ORDER BY image_type, sort_order;
 
</select>


</mapper>