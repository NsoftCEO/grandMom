<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="ko.dh.goot.dao.ProductMapper">

<resultMap id="ProductListResultMap" type="ko.dh.goot.dto.ProductListItem">
    <id property="productId" column="product_id"/>
    <result property="productName" column="product_name"/>
    <result property="price" column="price"/>
    <result property="salePrice" column="sale_price"/>
    <result property="status" column="status"/>
    <result property="createdAt" column="created_at"/>
    <result property="totalStock" column="total_stock"/>
    <result property="mainImageUrl" column="main_image_url"/>
</resultMap>

<resultMap id="ProductDetailResultMap" type="ko.dh.goot.dto.ProductDetail">
    <id property="productId" column="product_id"/>
    <result property="productName" column="product_name"/>
    <result property="price" column="price"/>
    <result property="salePrice" column="sale_price"/>
    <result property="description" column="description"/>
    <result property="status" column="status"/>
    <result property="createdAt" column="created_at"/>

    <association property="category" javaType="ko.dh.goot.dto.ProductCategory">
        <id property="categoryId" column="category_id"/>
        <result property="categoryName" column="category_name"/>
    </association>

    <collection property="images" ofType="ko.dh.goot.dto.ProductImage">
        <id property="imageId" column="image_id"/>
        <result property="imageUrl" column="image_url"/>
        <result property="imageType" column="image_type"/>
        <result property="sortOrder" column="sort_order"/>
    </collection>

    <collection property="options" ofType="ko.dh.goot.dto.ProductOption">
        <id property="optionId" column="option_id"/>
        <result property="color" column="color"/>
        <result property="size" column="size"/>
        <result property="stockQuantity" column="stock_quantity"/>
    </collection>
</resultMap>



	
<select id="selectProductList" parameterType="map" resultMap="ProductListResultMap">

    SELECT
        p.product_id,
        p.product_name,
        p.price,
        p.sale_price,
        p.status,
        p.created_at,
        IFNULL(opt.total_stock, 0) AS total_stock, /* 총 재고, 값이 null이면 0 반환 */
        img.image_url AS main_image_url /* 대표 이미지 */

    FROM product p

    /* 옵션 재고 집계 */
    LEFT JOIN (
        SELECT
            product_id,
            SUM(stock_quantity) AS total_stock
        FROM product_option
        GROUP BY product_id
    ) opt
        ON opt.product_id = p.product_id

    /* 대표 이미지 */
    LEFT JOIN product_image img
        ON img.product_id = p.product_id
       AND img.image_type = 'MAIN'
       AND img.use_yn = 'Y'
       AND img.sort_order = 0

    WHERE p.status = 'ACTIVE'

    <if test="categoryId != null">
        AND p.category_id = #{categoryId}
    </if>

    <if test="keyword != null and keyword != ''">
        AND p.product_name LIKE CONCAT('%', #{keyword}, '%')
    </if>

    ORDER BY p.created_at DESC

</select>

<select id="selectProductDetail" parameterType="long" resultMap="ProductDetailResultMap">
    SELECT
        p.product_id,
        p.product_name,
        p.price,
        p.sale_price,
        p.description,
        p.status,
        p.created_at,

        c.category_id,
        c.category_name,

        o.option_id,
        o.color,
        o.size,
        o.stock_quantity,

        i.image_id,
        i.image_url,
        i.image_type,
        i.option_id AS image_option_id,
        i.sort_order

    FROM product p

    LEFT JOIN product_category c
      ON p.category_id = c.category_id
     AND c.use_yn = 'Y'

    LEFT JOIN product_option o
      ON o.product_id = p.product_id

    LEFT JOIN product_image i
      ON i.product_id = p.product_id
     AND i.use_yn = 'Y'
     -- 옵션 이미지만 매핑되도록 (NULL은 대표 이미지)
     -- OR i.option_id = o.option_id

    WHERE p.product_id = #{productId}
      AND p.status = 'ACTIVE'

    ORDER BY
        o.option_id ASC,
        i.sort_order ASC
</select>



</mapper>