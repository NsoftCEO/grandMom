JPA 주요개념

1. 영속성 컨텍스트란?
영속성 컨텍스트(Persistence Context)는 엔티티를 관리하는 공간입니다.

 

Spring 환경에서는 일반적으로 @Transactional 단위로 생성되며, 내부적으로는 EntityManager가 관리합니다.

트랜잭션별로 존재하며(생존주기도 같음) 내부에 Map 구조의 1차캐시, 스냅샷 저장소가 존재합니다.

스냅샷 저장소에는 엔티티의 데이터를 원본으로 저장합니다.

 

PersistenceContext
├─ 1차 캐시
├─ 스냅샷 저장소
└─ ActionQueue

 

2. 1차 캐시
영속성 컨텍스트 내에 Map<(엔티티 타입 + PK), 엔티티 객체>구조로 엔티티의 PK별로 관리합니다.
한마디로, 1차 캐시는 (엔티티 타입 + PK) 조합을 Key로 하여 하나의 엔티티 객체를 관리합니다.

 

3. 변경 감지(Dirty Checking)
엔티티의 값을 변경(insert, update, delete)해도 즉시 SQL이 실행되지 않습니다.

 

엔티티 값을 변경하면 1차 캐시에 저장되어 있는 해당 엔티티 객체의 필드 값이 직접 변경됩니다.

이 시점에는 SQL이 실행되지 않습니다.

그리고 트랜잭션 종료시 flush하여 (스냅샷 저장소에 저장된 엔티티와 변경된 엔티티를 비교) SQL을 생성 -> DB에 전송 -> commit합니다.

 

4. flush
flush는 영속성 컨텍스트의 변경 내용을 DB에 반영하는 과정입니다.

트랜잭션 마지막에 처음 엔티티의 스냅샷과 비교하여 SQL 생성 -> DB에 전송 -> commit