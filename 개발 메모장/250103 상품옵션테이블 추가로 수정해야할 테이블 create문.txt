CREATE TABLE product (
    product_id    BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name          VARCHAR(255) NOT NULL
        COMMENT '상품명',
    base_price    INT NOT NULL
        COMMENT '기본 판매가',
    description   TEXT
        COMMENT '상품 상세 설명',
    category_id   INT NOT NULL
        COMMENT '카테고리 ID',

    created_at    TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB
DEFAULT CHARSET=utf8mb4
COMMENT='상품 기본 정보';


CREATE TABLE product_option (
    option_id          BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    product_id         BIGINT UNSIGNED NOT NULL,

    color              VARCHAR(50) NOT NULL DEFAULT '기본색상'
        COMMENT '색상',
    size               VARCHAR(50) NOT NULL DEFAULT 'FREE'
        COMMENT '사이즈',

    additional_price   INT NOT NULL DEFAULT 0
        COMMENT '옵션 추가 금액',
    stock_quantity     INT NOT NULL
        COMMENT '재고 수량',

    created_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT fk_product_option_product
        FOREIGN KEY (product_id)
        REFERENCES product(product_id),

    UNIQUE KEY uk_product_color_size (product_id, color, size)
) ENGINE=InnoDB
DEFAULT CHARSET=utf8mb4
COMMENT='상품 옵션 및 재고';


CREATE TABLE orders (
    order_id          BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id           BIGINT UNSIGNED NOT NULL,

    order_name        VARCHAR(255) NOT NULL
        COMMENT '주문명',
    total_amount      INT NOT NULL
        COMMENT '주문 총 금액',
    order_status      VARCHAR(20) NOT NULL
        COMMENT 'PAYMENT_READY, PAID, CANCELLED, REFUNDED',

    receiver_name     VARCHAR(100) NOT NULL,
    receiver_phone    VARCHAR(30) NOT NULL,
    receiver_address  VARCHAR(255) NOT NULL,
    delivery_memo     VARCHAR(255),

    created_at        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB
DEFAULT CHARSET=utf8mb4
COMMENT='주문 정보';


CREATE TABLE order_item (
    order_item_id   BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    order_id        BIGINT UNSIGNED NOT NULL,
    product_id      BIGINT UNSIGNED NOT NULL,
    option_id       BIGINT UNSIGNED NOT NULL,

    product_name    VARCHAR(255) NOT NULL
        COMMENT '주문 시점 상품명',

    option_snapshot JSON
        COMMENT '주문 시점 옵션 스냅샷 (color, size, 추가금)',

    unit_price      INT NOT NULL
        COMMENT '개당 가격 (기본가 + 옵션가)',
    quantity        INT NOT NULL
        COMMENT '수량',
    total_price     INT NOT NULL
        COMMENT 'unit_price × quantity',

    refund_status   VARCHAR(20) NOT NULL DEFAULT 'NONE'
        COMMENT 'NONE, REQUESTED, PARTIAL, REFUNDED',

    created_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT fk_order_item_order
        FOREIGN KEY (order_id)
        REFERENCES orders(order_id),

    CONSTRAINT fk_order_item_product
        FOREIGN KEY (product_id)
        REFERENCES product(product_id),

    CONSTRAINT fk_order_item_option
        FOREIGN KEY (option_id)
        REFERENCES product_option(option_id)
) ENGINE=InnoDB
DEFAULT CHARSET=utf8mb4
COMMENT='주문 상품 상세';
