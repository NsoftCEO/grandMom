260223 todo

ì›¹í›… PAID ì•„ë‹ë•Œ ì²˜ë¦¬

// ... existing code ...
    @Value("${portone.store-id}")
    private String storeId;

    @Value("${portone.api-secret}")
    private String apiSecret;
    
    private static final String TRANSACTION_PAID = "Transaction.Paid";
    private static final String TRANSACTION_FAILED = "Transaction.Failed";
    private static final String TRANSACTION_CANCELLED = "Transaction.Cancelled";

    // ì›¹í›…ì—ì„œ 500ì„ returní•˜ë©´ ì›¹í›… ìˆ˜ë°± ë²ˆ ì¬ì „ì†¡ ë”°ë¼ì„œ ì‹¤íŒ¨í–ˆì–´ë„ DBì— ë‚¨ê¸°ê³ , 200ì„ ì¤€ë‹¤.
    public void handlePaymentWebhook(String payload, String webhookId, String webhookSignature, String webhookTimestamp) {
// ... existing code ...
        try {       
            
            WebhookPayload payloadData = objectMapper.readValue(payload, WebhookPayload.class);

            log.info("[Webhook] payload={}", payloadData);
                    
            String webhookType = payloadData.getType();
            String paymentId = payloadData.getData() != null ? payloadData.getData().getPaymentId() : null;
            
            if (paymentId == null) {
                throw new WebhookException(ErrorCode.WEBHOOK_INVALID_PAYLOAD, "paymentId is null. payloadData=" + payloadData);
            }

            if (TRANSACTION_PAID.equals(webhookType)) {
                /* ===== 1. ë©±ë“±ì„± (ê°€ì¥ ë¨¼ì €) ===== */
                if (paymentMapper.existsByPaymentId(paymentId) > 0) {
                    log.info("ì´ë¯¸ ì²˜ë¦¬ëœ ê²°ì œ. paymentId={}", paymentId);
                    return;
                }
                confirmPaymentAndCompleteOrder(paymentId);
            } else if (TRANSACTION_FAILED.equals(webhookType) || TRANSACTION_CANCELLED.equals(webhookType)) {
                // ê²°ì œ ì‹¤íŒ¨ ë˜ëŠ” ì·¨ì†Œ ì›¹í›… ìˆ˜ì‹  ì‹œ ìƒíƒœ ë™ê¸°í™”
                syncFailedOrCancelledPayment(paymentId);
            } else {
                log.info("[Webhook] Ignore type={}", webhookType);
                return; // ì •ìƒ return, 200ë¦¬í„´í•˜ì—¬ ì›¹í›…ìš”ì²­ ë§‰ìŒ
            }
            
        } catch (JsonProcessingException e) {
            log.error("ğŸš¨ [Webhook] JSON íŒŒì‹± ì‹¤íŒ¨. payload={}", payload, e);
// ... existing code ...
        // ===== 9. ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ =====
        int resultCount = orderService.changeOrderStatus(orderId,"PAYMENT_READY", pgPayment.getStatus());
       
        if(resultCount != 1) {
            throw new BusinessException(ErrorCode.ORDER_STATUS_UPDATE_FAILED, "orderId=" + orderId);                    
        }

        
    }
    
    public void syncFailedOrCancelledPayment(String paymentId) {
        /* ===== í¬íŠ¸ì› ê²°ì œ ë‚´ì—­ ì¡°íšŒ ===== */
        PortOnePaymentResponse pgPayment = portoneApiService.portonePaymentDetails(paymentId);

        if (pgPayment == null) {
            log.warn("[Webhook] í¬íŠ¸ì› ê²°ì œ ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. paymentId={}", paymentId);
            return;
        }

        syncFailedOrCancelledPaymentInternal(pgPayment);
    }

    @Transactional
    public void syncFailedOrCancelledPaymentInternal(PortOnePaymentResponse pgPayment) {
        Long orderId = pgPayment.getOrderId();

        OrderEntity order = orderMapper.selectOrder(orderId);
        if (order == null) {
            log.warn("[Webhook] ì£¼ë¬¸ ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. orderId={}", orderId);
            return;
        }

        // ì´ë¯¸ ì‹¤íŒ¨ë‚˜ ì·¨ì†Œ ìƒíƒœë©´ ë¬´ì‹œ (ë©±ë“±ì„± ë³´ì¥)
        if ("PAYMENT_FAILED".equals(order.getStatus()) || "CANCELLED".equals(order.getStatus())) {
            log.info("[Webhook] ì´ë¯¸ ì·¨ì†Œ/ì‹¤íŒ¨ ì²˜ë¦¬ëœ ì£¼ë¬¸ì…ë‹ˆë‹¤. orderId={}, status={}", orderId, order.getStatus());
            return;
        }

        // í¬íŠ¸ì› ê²°ì œ ìƒíƒœì— ë”°ë¼ íƒ€ê²Ÿ ìƒíƒœ ê²°ì • (ê²°ì œ ì‹¤íŒ¨ vs ê²°ì œ ì™„ë£Œ í›„ ì·¨ì†Œ)
        String pgStatus = pgPayment.getStatus(); // "FAILED", "CANCELLED" ë“±
        String targetStatus = "CANCELLED".equals(pgStatus) ? "CANCELLED" : "PAYMENT_FAILED";

        // ìƒíƒœ ë³€ê²½
        int resultCount = orderService.changeOrderStatus(orderId, order.getStatus(), targetStatus);
        
        if (resultCount == 1 && "CANCELLED".equals(targetStatus)) {
            // [ì£¼ì˜] ê²°ì œ ì™„ë£Œ(PAID) ì‹œì ì— ì¬ê³ ë¥¼ ì°¨ê°í–ˆë‹¤ë©´, ì·¨ì†Œ(CANCELLED) ì‹œì ì—ëŠ” ì¬ê³ ë¥¼ ë³µêµ¬í•´ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.
            // OrderItemEntity orderItem = orderItemMapper.selectOrderItemByOrderId(orderId);
            // if (orderItem != null) {
            //     productOptionService.increaseStock(orderItem.getOptionId(), orderItem.getQuantity());
            // }
            log.info("[Webhook] ê²°ì œ ì·¨ì†Œì— ë”°ë¥¸ ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì™„ë£Œ. orderId={}", orderId);
        } else if (resultCount == 1) {
            log.info("[Webhook] ê²°ì œ ì‹¤íŒ¨ì— ë”°ë¥¸ ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì™„ë£Œ. orderId={}", orderId);
        }
    }

}